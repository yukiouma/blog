---
title: 本地快捷部署私有镜像仓库
date: 2021-08-30 21:07:37
tags: 
- Docker
categories:
- DevOps
---



## 环境

* OS

  CentOS Linux release 7.9.2009 (Core)

* Docker

  20.10.6

<!-- more -->

## 说明

假定有一个域名叫workspace，可以被设备解析为正确的IP地址，私有仓库部署在该IP的设备上

如果没有可以被正常解析的域名，在设置信任仓库的时候直接使用IP+端口的形式即可



## 步骤



1. 拉取私有仓库的镜像

   ```bash
   docker pull registry
   ```

   

2. 运行私有仓库

   ```bash
   docker run -di --name registry -p 5000:5000 registry
   ```

   

3. 设置非https的信任仓库

   ```bash
   vi /etc/docker/daemon.json
   ```

   写入以下内容

   ```json
   {
   	"insecure-registries": ["workspace:5000"]
   }
   ```

   

4. 重启docker

   ```bash
   systemctl restart docker
   ```

   

5. 查看私有仓库中的镜像列表

   ```bash
   curl http://workspace:5000/v2/_catalog
   ```

   返回结果为

   ```bash
   {"repositories":[]} # 此时镜像位空，返回空数组
   ```

   

6. 尝试将一个本地镜像推送至该私有镜像

   

   先为本地镜像打上标签

   ```bash
   docker tag janus-design:v1 workspace:5000/janus-design:v1
   ```

   

   推送至私有仓库

   ```bash
   docker push workspace:5000/janus-design:v1
   ```

   

   再次查看私有仓库镜像列表

   ```bash
   [root@workspace ~]# curl http://workspace:5000/v2/_catalog
   {"repositories":["janus-design"]}
   ```

   此时列表存在刚上传的镜像了

   

7. 尝试在另一台设备拉去该镜像

   ```bash
   [root@k8smaster ~]# docker pull workspace:5000/janus-design:v1
   v1: Pulling from janus-design
   5d20c808ce19: Already exists 
   724902b3d072: Pull complete 
   Digest: sha256:10d2ab23ea72418d274f210bee8624eb6474ed1d88915d90790514ff92860e7e
   Status: Downloaded newer image for workspace:5000/janus-design:v1
   ```

   可以看到拉取成功
   
   
   
8. 其它web api参考文档

   [Dokcer Registry](https://docs.docker.com/registry/)

